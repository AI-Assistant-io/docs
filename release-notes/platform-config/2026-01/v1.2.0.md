---
title: "v1.2.0"
date: 2026-01-22
---

# Release 1.2.0 - Self-Contained Deployment with User-Assigned Managed Identity

**Branch:** main
**Date:** 2026-01-22
**Author:** Development Team

---

## Summary

Updated deployment architecture to bundle frontend and backend into a single self-contained container. The application queries Cosmos DB directly using a **User-Assigned Managed Identity** for secure, keyless authentication in production.

---

## Changes

### Security

1. **User-Assigned Managed Identity** - `backend/server.js`
   - Production uses user-assigned managed identity (no keys stored)
   - Identity persists independently of container app lifecycle
   - Can be shared across multiple applications
   - Local development continues to use key-based auth via `.env` files
   - Added `@azure/identity` package for credential handling
   - Health endpoint reports authentication method being used

2. **GitHub Actions Identity Management** - `.github/workflows/deploy-to-azure.yml`
   - Creates user-assigned identity if it doesn't exist
   - Assigns identity to container app
   - Grants "Cosmos DB Built-in Data Contributor" role to the identity
   - No database keys in environment variables

### Deployment Architecture

1. **Single Container Deployment** - `Dockerfile.azure`
   - Multi-stage build: frontend builder → backend builder → production image
   - Frontend served via nginx on port 8080
   - Backend runs on internal port 3101
   - Supervisor manages both nginx and Node.js processes

2. **Nginx API Proxy** - `nginx.conf`
   - Added reverse proxy configuration for `/api/*` routes
   - Proxies requests to backend at `127.0.0.1:3101`
   - Includes proper headers for WebSocket support

3. **Process Management** - `supervisord.conf` (new)
   - Manages nginx and backend Node.js processes
   - Auto-restart on failure
   - Logs to stdout/stderr for container logging

---

## Configuration

### New GitHub Secrets Required

| Secret | Description |
|--------|-------------|
| `COSMOS_ENDPOINT` | Cosmos DB endpoint URL (e.g., `https://your-cosmos.documents.azure.com:443/`) |
| `COSMOS_DATABASE` | Database name (e.g., `aiadatabase`) |
| `COSMOS_CONTAINER` | Container name (e.g., `configurations`) |
| `COSMOS_ACCOUNT_NAME` | Cosmos DB account name (for role assignment) |
| `COSMOS_RESOURCE_GROUP` | Resource group containing Cosmos DB account |
| `MANAGED_IDENTITY_NAME` | Name for the user-assigned managed identity |
| `MANAGED_IDENTITY_RESOURCE_GROUP` | Resource group for the managed identity |

### Secrets No Longer Required

- `COSMOS_KEY` - Replaced by managed identity
- `REACT_APP_AUTOMATION_API_URL` - Now handled internally via nginx proxy

---

## Architecture

```
┌──────────────────────────────────────────────────────────────┐
│              User-Assigned Managed Identity                   │
│              (Independent lifecycle)                          │
└──────────────────────────┬───────────────────────────────────┘
                           │ Assigned to
                           ▼
┌─────────────────────────────────────────────────────────┐
│           Azure Container App (Port 8080)                │
│  ┌─────────────────────────────────────────────────────┐│
│  │                     Supervisor                       ││
│  │  ┌─────────────────┐    ┌─────────────────────────┐ ││
│  │  │      Nginx      │    │    Node.js Backend      │ ││
│  │  │   (Port 8080)   │───▶│      (Port 3101)        │ ││
│  │  │                 │    │                         │ ││
│  │  │ Static Files +  │    │   /api/GetDocumentById  │ ││
│  │  │ Proxy /api/*    │    │   /api/UpdateDocById    │ ││
│  │  └─────────────────┘    └───────────┬─────────────┘ ││
│  └─────────────────────────────────────┼───────────────┘│
└────────────────────────────────────────┼────────────────┘
                                         │ Managed Identity
                                         ▼ (No Keys)
                              ┌─────────────────────┐
                              │    Azure Cosmos DB   │
                              │  [RBAC Data Access]  │
                              └─────────────────────┘
```

---

## User-Assigned vs System-Assigned Identity

| Feature | User-Assigned (Current) | System-Assigned |
|---------|------------------------|-----------------|
| Lifecycle | Independent | Tied to app |
| Sharing | Can share across apps | One app only |
| Pre-configuration | Yes | No |
| Recreate app | Identity persists | Identity deleted |
| Management | Manual | Automatic |

---

## Files Changed

- `backend/package.json` - Added `@azure/identity` dependency
- `backend/server.js` - Dual auth: managed identity (prod) / key (dev)
- `Dockerfile.azure` - Multi-stage build with frontend + backend
- `nginx.conf` - Added API proxy configuration
- `supervisord.conf` - New file for process management
- `.github/workflows/deploy-to-azure.yml` - User-assigned identity setup + role assignment
- `.dockerignore` - Updated to include backend, exclude env files

---

## Breaking Changes

1. **New GitHub Secrets Required** - Deployment will fail without Cosmos DB and identity secrets
2. **External API No Longer Used** - Application is now fully self-contained
3. **Managed Identity Required** - Service principal must have permissions to:
   - Create/read managed identities
   - Assign identities to container apps
   - Create Cosmos DB SQL role assignments

---

## Migration Notes

1. Add the following secrets to your GitHub repository:
   - `COSMOS_ENDPOINT`
   - `COSMOS_DATABASE`
   - `COSMOS_CONTAINER`
   - `COSMOS_ACCOUNT_NAME`
   - `COSMOS_RESOURCE_GROUP`
   - `MANAGED_IDENTITY_NAME` (e.g., `platform-config-identity`)
   - `MANAGED_IDENTITY_RESOURCE_GROUP`

2. Ensure the Azure service principal (in `AZURE_CREDENTIALS`) has permissions to:
   - `Microsoft.ManagedIdentity/userAssignedIdentities/read`
   - `Microsoft.ManagedIdentity/userAssignedIdentities/write`
   - `Microsoft.App/containerApps/write`
   - `Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments/write`

3. The `COSMOS_KEY` secret can be removed after successful deployment

4. Local development still uses key-based auth via `backend/.env.preprod` or `backend/.env.prod`

5. Verify managed identity is working by checking `/api/health`:
   ```json
   {
     "status": "ok",
     "cosmos": {
       "authMethod": "managed-identity",
       "connected": true
     }
   }
   ```
